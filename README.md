# character_chat.py

## 概要

OpenAIのAPIを利用して、設定したキャラクターと日本語で会話するチャットスクリプトです。
会話文をCoT（Chain of Thought）で生成、すなわち、ボットはユーザーの発言内容を受け取り、思考してから返事を行います。

CoTを採用することで、キャラクターの一貫性を保つことを目指しました。もっと具体的にいうと、ChatGPTの「アシスタントAI」としての人格を隠蔽することが目的です。

また、キャラ設定、サンプル会話、直近の会話に加え、古い会話内容は要約した上で、コンテキストに含めます。これはChatGPTのように、AIが生成した台詞がコンテキストに蓄積されることにより、キャラ崩壊が進行する問題の解決を図るためです。
（現在のバージョンでは昔の記憶は利用していませんが、長期記憶として随時呼び出す仕組みを構想中です。）

キャラ設定、会話要約、会話内容は、キャラ（会話）毎にJSONファイルとして保存できます。会話内容はファイルに追記されていくので、会話の中断、再開が可能です。

このスクリプトは、ご自分のAPIキーを用いて、ご自分が使用することを想定しています。ご自身の責任において使用してください。

## 事前準備

1. OpenAIモジュールをインストールしてください。
	```bash
	pip install openai
	```
1. 環境変数`OPENAI_API_KEY`に、ご自分のAPIキーを記述してください。
	Windows環境なら以下のようなバッチファイルを作ると便利でしょう。
	```
	@echo off
	set OPENAI_API_KEY=あなたのAPI_KEY
	python character_chat.py conversations_sample_01.json
	```

1. 会話ファイル（JSON形式）に、下記の書式でキャラ設定を記述してください。なおこのファイルに会話ログも追記されます。サンプルをいくつか用意しているので参考にしてください。


## 実行方法

### 構文
```bash
python character_chat.py [-h] [--model model] [--input text] [--run-once] [--format] [--rapid-mode-threshold length] [--send-url url] [--no-show-action] [--no-show-error] json_path
```

### パラメータ
- 必須パラメータ:
	- json_path
		- 会話JSONファイルパス。ファイルはスクリプトファイルと同一ディレクトリに配置するか、フルパスを指定。

- オプションパラメータ:
	- -h, --help
		- ヘルプメッセージを表示して終了する
	- --model model, -m model
		- 使用するOpenAIモデル。`gpt-3.5-turbo`もしくは`gpt-4`が指定可能（デフォルト値：`gpt-3.5-turbo`）
	- --input text, -i text
		- ユーザーの最初の発言を指定
	- --run-once, -r
		- APIを実行してすぐに終了
	- --format, -f
		- JSON形式で出力
	- --rapid-mode-threshold length
		- 簡易モードを有効にする最大文字数。この文字数を超えると通常モード。（デフォルト値：6）
	- --send-url url
		- AIの発言を送信するURL（例：http://localhost:8080/t={speech}）
	- --no-show-action
		- AIの行動内容をコンソールに表示しない
	- --no-show-error
		- AIが台詞を生成できなかった場合でもエラーメッセージを表示しない


`--model`オプションには、`gpt-3.5-turbo`（デフォルト）か`gpt-4`のどちらかを指定してください。このスクリプトは1回のAPI呼び出しに3000トークン前後消費しますので、使用料金を鑑み、モデル選択には十分注意してください。ただし、`gpt-3.5-turbo`では十分な会話精度が得られないかもしれません。

## 使用法

### 基本
character_chat.pyを起動し、コンソールに何か発言を書き込みEnterキーを押下すると、そのたびにOpenAIのChat APIを用いて返答が生成されます。これは会話なので、入力は最大100字くらいが良いです。コンソールにはAIの発言が表示され、（）内にAIの行動が表示されます。

```
ユーザー: こんにちは。よろしくお願いします。
AI: ユーザーさん、こんにちは。お元気ですか？（返事を返した。）
```
入力に倫理的あるいは論理的な問題（設定に矛盾する等）があり、モデルが回答を生成できなかった場合は、モデルが出力した文字列を、エラーメッセージとしてコンソールに出力します。

あるいは、--inputパラメータ（or 標準入力）と--run-onceパラメータを指定し、発言を1回して即時終了させることもできます
```
> python character_chat.py conversations_sample_01.json --input "こんにちは。よろしくお願いします。" --run-once
ユーザーさん、こんにちは。お元気ですか？（返事を返した。）
```

### 行動の記述
文末に（）で自分の行動を書くこともできます。
```
ユーザー: おーい。（手を振って声を掛ける）
```

### 指示モード

```
ユーザー: 手を上げなさい（指示）
```
のように書くと、ボットは自ら思考せず、こちらの指示通りに行動します。

### 自動モード
```
ユーザー: （自動）
```
のように書くと、ユーザーの発言も自動的に生成します。

### 簡易モード

こちらの発言が6文字以内である場合、ボットは思考せず、これまでの会話の流れに沿った簡易的な応答をします。使用トークンが節約され、迅速な回答が得られます。


## 出力ファイル
### 会話出力

- `*.json`: 会話のログは、APIを呼び出すたびに、会話ファイル（ファイル名は任意）に追記されていきます。そのためスクリプト終了後も会話の続きが行えます。ファイルはキャラクター毎に作成でき、コマンドラインオプションでキャラクターを切り替えることが可能です。
- `thought.txt`: 「現在ボットが考えていること」が出力されます。このファイルは出力のたびに上書きされます。たまに覗き見すると楽しいかもしれません。
- `prompt.txt`: 実行したプロンプトとAPI出力を上書き出力します。参考用です。

### 要約出力

会話（ユーザーの発言→ボットの発言）が6回実行されるか、現在の会話が1000字を超えた際に、自動的に会話が要約されます。ボットの発言が出力された直後に連続して、OpenAIのChat APIを1回実行し、会話内容とボットの思考に分けて要約されます。この要約文はコンソールには出力されませんが、`summary.txt`に上書き出力され、会話ファイルにも追記されます。要約後、会話記憶は直近3回分だけ残されます。直近の要約文は、現在の会話で参照されます。
なお、要約は設定にかかわらず、常に`gpt-3.5-turbo`により行われます。

## 終了方法

スクリプトを終了させるには、強制終了してください。

## 会話ファイル（.json）の書式

[サンプル](./examples/)を用意しているので、詳しくはそちらを参照のこと。

- `title`: 会話のタイトル
- `speaker1`: あなたの名前
- `speaker2`: ボットの名前
- `story`: キャラクター設定（外見、性格、趣味、知識レベル、あなたとの関係性、口調、台詞例etc）、あなた自身のプロフィール、ストーリー（世界観、会話の状況、場所、時間帯）などを自由に記述してください。文章でも箇条書きでもOKです。日本語だと500～800字くらいが良さそうです。トークン節約と思考能力アップを期待するなら、英語で書くのがいいかもしれません。`{speaker1}`,`{speaker2}`,`{today}`,`{time}`という変数が使えます。`story`は現在の会話で毎回参照されます。
	- Tips: storyはChatGPTに作成させるのがお勧めです。
- `examples`: 会話例をリストで記載します。`examples`は現在の会話で毎回参照されます。会話例は3つくらいあれば良さそうです。各会話は以下の要素で構成されます。
	1. speaker1（あなた）の台詞（最大100字程度）
	1. speaker1（あなた）の行動（最大50字程度）
	1. speaker2（ボット）の理解（speaker1の台詞、行動をどう理解したか。最大50字程度）
	1. speaker2（ボット）の思考（理解に基づき、何を感じ、何をしようと思ったか。最大50字程度）
	1. speaker2（ボット）の行動（思考の結果、どういう行動をしたか。最大50字程度）
	1. speaker2（ボット）の台詞（思考の結果、最終的になんと発言したか。最大100字程度）
- `oldConversations`: 過去に行った会話リスト
	- `summary`: 会話の要約。直近2つの`summary`のみ、現在の会話で参照されます。
	- `thought`: speaker2（ボット）がその会話で思ったことの要約。直近の`thought`のみ、現在の会話で参照されます。
	- `conversations`: 会話内容のリスト（`examples`と同じフォーマット）。この会話リストは現在の会話で参照されません。
- `conversations`: 現在の会話リスト。現在の会話で参照されます。ここに会話履歴が蓄積されていきます。会話履歴が6個溜まると、新しい3個を残し、古い3個が`oldConversations`に移動します。
